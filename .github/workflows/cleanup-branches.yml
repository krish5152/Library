name: Delete Old Branches

on:
  schedule:
    # Runs every day at midnight
    - cron: '0 0 * * *'

  workflow_dispatch: # Allows manual triggering of the workflow
  
jobs:
  delete-old-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install Git
        run: sudo apt-get install git

      - name: Fetch all branches
        run: git fetch --all --prune

      - name: Delete branches older than a week
        env:
          GH_TOKEN: ${{ secrets.FULL_PERMISSION_PAT }}  # Use the secret for authentication
        run: |
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git
          for branch in $(git for-each-ref --sort=-committerdate refs/remotes --format='%(refname:short) %(committerdate:relative)' | grep -E 'week|weeks ago' | awk '{print $1}'); do
            if [[ $branch != "origin/master" ]]; then
              git push origin --delete ${branch#origin/}
              echo "Deleted branch: $branch"
            fi
          done
